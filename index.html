<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Hellesylt Guide 2026</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#2A5B87" />
    <meta name="description" content="Guía turística interactiva para Hellesylt y Geiranger 2026" />
    
    <!-- PWA -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEizvd29U2jrgvItZ1NdjgP38bME0SfqcLvLzKL5XbYhxuXx27NmHj1jtvFW_dT-OQQLv0VoyZ2N06GLc0W6X4ny1FBObFKPMCKOtC829BpaTS9AZAsK1Of2ced1T29g5mCQ6QIaHz2DZA_Q4oHDkLxJCxm9UdjQw1ENA_ts8xVdDCccmdQ5Z391DLw2e-Y/s320/Gemini_Generated_Image_dejh51dejh51dejh.png" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              fjord: { 50:'#f0f9ff', 100:'#e0f2fe', 500:'#2A5B87', 600:'#0284c7', 900:'#0c4a6e' },
              mountain: { 500:'#3A7D44' },
              sunset: { 500:'#FFB347' }
            },
            fontFamily: { sans: ['Roboto Condensed', 'sans-serif'] },
            animation: {
                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }
          }
        }
      }
    </script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1",
    "leaflet": "https://aistudiocdn.com/leaflet@^1.9.4",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "recharts": "https://aistudiocdn.com/recharts@^3.5.1"
  }
}
</script>
    
    <!-- Leaflet JS Global -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { background-color: #f8fafc; overscroll-behavior-y: none; }
        .leaflet-container { width: 100%; height: 100%; z-index: 0; }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 4px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content { animation: fadeIn 0.2s ease-out forwards; }
        
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .active-card { animation: pulse-border 2s infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { CalendarClock, Map as MapIcon, Wallet, BookOpen, Anchor, CheckCircle2, Circle, MapPin, AlertTriangle, Clock, ArrowRight, TrendingDown, Info, AlertCircle, ShoppingBag, Volume2, Camera, CloudSun, Wind, Droplets, Umbrella, X, Eye, Lightbulb, ChevronDown, Ticket, Zap, Calculator, ArrowRightLeft, RefreshCw, Languages, Utensils, Instagram, CloudRain, CloudSnow, Sun, Smartphone, Sunrise, Sunset, Moon, Play, Plus, Trash2, Headphones, Pause, StopCircle } from 'lucide-react';

        // --- CONSTANTS ---
        const SHIP_DEPARTURE_TIME = "21:00";
        const ARRIVAL_TIME = "09:00";
        const ONBOARD_TIME = "20:30";
        const UPDATE_DATE = "09 de diciembre de 2025";
        
        // Coordenadas Actualizadas
        const COORDS = {
            HELLESYLT_CRUISE_DOCK: { lat: 62.085348, lng: 6.873744 }, // Puerto de Cruceros
            HELLESYLT_FERRY_DOCK: { lat: 62.087367, lng: 6.869952 },  // Puerto del Ferry
            HELLESYLT_WATERFALL: { lat: 62.086675, lng: 6.865685 },   // Hellesyltfossen
            
            GEIRANGER_FERRY_DOCK: { lat: 62.103568, lng: 7.202824 },  // Puerto Ferry Geiranger
            SEVEN_SISTERS: { lat: 62.106854, lng: 7.093885 },         // Cascada 7 Hermanas
            
            FLYDAL: { lat: 62.091142, lng: 7.223091 },                // Mirador Flydalsjuvet
            ORNESVINGEN: { lat: 62.126299, lng: 7.167320 },           // Mirador Ørnesvingen
            
            STORFOSSEN_START: { lat: 62.098041, lng: 7.204759 },      // Inicio Waterfall Walk
            FOSSEVANDRING_VIEW: { lat: 62.097005, lng: 7.209251 }     // Mirador Fossevandring
        };

        const HELLESYLT_AUDIO_TRACKS = [
            {
                id: 1,
                title: "1. La Llegada al Fiordo",
                text: "¡Bienvenidos a Hellesylt! Si estás escuchando esto, es porque ya estás en cubierta respirando uno de los aires más puros de Europa. Mira a tu alrededor. Estamos al final del Sunnylvsfjorden, un brazo lateral del gran Storfjord. ¿Notas la diferencia con otros puertos? Aquí no hay grandes terminales de cemento ni ruido de ciudad. Hellesylt es un puerto natural que ha sido utilizado desde la Era Vikinga. Hace mil años, los barcos no eran cruceros de acero, sino drakkars de madera que buscaban refugio en estas aguas tranquilas de color esmeralda. Este pequeño pueblo, de apenas 300 habitantes, vive en un equilibrio perfecto. Las montañas que ves alzarse casi verticalmente sobre nosotros actúan como murallas protectoras, resguardando el valle del clima más duro del océano. Tómate un momento antes de bajar. Mira el reflejo de los picos en el agua. Estás a punto de pisar un lugar donde la naturaleza sigue siendo la dueña absoluta."
            },
            {
                id: 2,
                title: "2. La Gran Cascada",
                text: "Ahora, busca el movimiento. Dirige tu vista hacia el centro del pueblo, justo entre las casas. ¿Lo ves? Esa es la Hellesyltfossen. Es el corazón, literalmente rugiente, de Hellesylt. Es muy raro ver una cascada de este caudal atravesando el centro mismo de una población. El agua que ves caer con esa fuerza blanca y espumosa viene del deshielo de los glaciares y las nieves altas. Cae sobre lechos de granito pulido por siglos de erosión y termina su viaje justo aquí, bajo nuestro barco. Aquí va el secreto para tu visita: Cuando bajes a tierra, verás un viejo puente que cruza la cascada por la mitad. Tienes que ir allí. No te conformes con verlo desde lejos. Al pararte en ese puente, sentirás la bruma fría en la cara y el estruendo del agua te impedirá hablar. Es una sensación de poder increíble. Además, desde ese puente, con el fiordo y nuestro barco de fondo, tendrás la mejor fotografía de todo el crucero."
            },
            {
                id: 3,
                title: "3. Arquitectura y Vida Local",
                text: "Mientras caminas por el muelle, fíjate en las construcciones. Estás viendo la arquitectura clásica de los fiordos occidentales. Casas de madera, techos a dos aguas preparados para soportar toneladas de nieve en invierno, y esos colores característicos: Rojo óxido, que antiguamente era la pintura más barata hecha con sangre de pescado y aceite; Amarillo ocre, y Blanco, que solía ser símbolo de riqueza. Si tienes tiempo para caminar un poco más, busca la Iglesia de Sunnylven. Es ese edificio de madera que vigila el fiordo desde 1859. Si la encuentras abierta, entra. El olor a madera antigua y el silencio en su interior son un bálsamo para el alma. Hellesylt no es un lugar de grandes monumentos de piedra, es un lugar de madera, agua y resistencia humana frente al clima."
            },
            {
                id: 4,
                title: "4. Despedida y El Camino",
                text: "Para terminar, una nota curiosa sobre nuestra ubicación. Hellesylt es conocida como la 'Puerta de Entrada'. Muchos viajeros desembarcan aquí para tomar la ruta terrestre hacia el famoso fiordo de Geiranger. Si vas a hacer esa excursión, prepárate para ver el lago más profundo de Europa en el camino. Pero si te quedas aquí, en Hellesylt, disfruta del lujo del tiempo. Siéntate en un banco frente al agua. Observa cómo cambia la luz sobre las montañas cada diez minutos. Aquí, el espectáculo no lo pone el hombre, lo pone el cielo. Disfruta de tu escala en Hellesylt. Camina despacio, respira hondo y llévate este paisaje grabado en la retina. Nos vemos al regreso a bordo."
            },
            {
                id: 5,
                title: "BONUS: Leyendas Ocultas",
                text: "Gigantes de Piedra: Mirad esas montañas de nuevo... Pero esta vez, no busquéis picos ni nieve. Buscad caras. Buscad narices deformes en la roca. La mitología noruega nos dice que el paisaje que os rodea no es geología... es un cementerio de Trolls. Cuenta la leyenda que estas inmensas paredes de granito eran, hace miles de años, gigantes que gobernaban la noche. Eran seres poderosos pero lentos de pensamiento. Una noche, discutiendo o persiguiendo a alguna doncella, perdieron la noción del tiempo. Y aquí, la regla es sagrada: si el sol te toca, te conviertes en piedra para siempre. La Huldra: Pero los Trolls no son lo único. Si decidís caminar cerca de la cascada o senderos boscosos, cuidado si escucháis una melodía hermosa. Podría ser la Huldra. Una criatura del bosque, increíblemente bella, que seduce a viajeros solitarios. Su secreto: tiene cola de vaca. Si os cruzáis con ella, no os asustéis, saludad con respeto y seguid vuestro camino. Y recordad: en Noruega decimos que la naturaleza está viva. Aquí somos invitados en el hogar de los gigantes."
            }
        ];

        const INITIAL_ITINERARY = [
            {
                id: '0', title: 'Desayuno Buffet MSC', startTime: '08:00', endTime: '08:30',
                locationName: 'MSC Euribia', coords: COORDS.HELLESYLT_CRUISE_DOCK,
                description: 'Desayuno en el Buffet del MSC EURIBIA.',
                fullDescription: 'Disfruta del desayuno buffet en el MSC Euribia. Es importante comer bien antes de iniciar la excursión de día completo.',
                tips: 'El buffet suele estar concurrido, ve con tiempo.',
                keyDetails: 'Buffet MSC.',
                priceNOK: 0, priceEUR: 0, type: 'food', completed: false
            },
            {
                id: '1', title: 'Llegada a Hellesylt', startTime: '09:00', endTime: '09:00',
                locationName: 'Muelle Crucero MSC', coords: COORDS.HELLESYLT_CRUISE_DOCK,
                description: 'Llegada al puerto de Hellesylt.',
                fullDescription: 'Llegada al puerto de Hellesylt. El barco atraca en el muelle de cruceros (Hellesylt Cruise Quay).',
                tips: 'Disfruta del entorno tranquilo antes de iniciar las actividades. Ubica el muelle del Ferry que está a unos minutos caminando.',
                keyDetails: 'Llegada 09:00.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/hellesylt/'
            },
            {
                id: '2', title: 'Descubriendo Hellesylt', startTime: '09:30', endTime: '10:45',
                locationName: 'Cascada Hellesylt', coords: COORDS.HELLESYLT_WATERFALL,
                description: 'Paseo matinal y cascada.',
                fullDescription: 'Disfruta del entorno. La cascada de Hellesylt cae directamente al fiordo y está a pocos metros del muelle del Ferry.',
                tips: 'Prioridad Baja Movilidad: La cascada se ve genial desde el puente junto al Grand Hotel.',
                keyDetails: 'Cascada impresionante.',
                priceNOK: 0, priceEUR: 0, type: 'sightseeing', completed: false,
                webcamUrl: 'https://www.youtube.com/live/S4aJlRY39fo?si=35XxdvEMmIpv4Ea4', 
                instagramUrl: 'https://www.instagram.com/explore/tags/hellesyltfossen/',
                hasAudioGuide: true
            },
            {
                id: '3', title: 'Embarque Ferry (IDA)', startTime: '10:45', endTime: '11:00',
                locationName: 'Muelle Ferry', coords: COORDS.HELLESYLT_FERRY_DOCK,
                description: 'Prepárate para embarcar.',
                fullDescription: 'Dirígete al muelle del ferry (distinto al del crucero). Muestra tu ticket de norwaysbest.com. Asegúrate de estar en la cola correcta.',
                tips: 'Ten los tickets digitales o impresos a mano.',
                keyDetails: 'Salida puntual 11:00.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false,
                ticketUrl: 'https://www.norwaysbest.com/es/geiranger/actividades/crucero-por-el-fiordo-geiranger'
            },
            {
                id: '4', title: 'Navegación a Geiranger', startTime: '11:00', endTime: '12:05',
                locationName: 'Fiordo Geiranger', endLocationName: 'Puerto Geiranger',
                coords: COORDS.HELLESYLT_FERRY_DOCK, endCoords: COORDS.GEIRANGER_FERRY_DOCK,
                description: 'Crucero por el fiordo UNESCO.',
                fullDescription: 'Trayecto espectacular de Hellesylt a Geiranger. Pasarás por las famosas cascadas de las Siete Hermanas (Seven Sisters), el Pretendiente y el Velo de la Novia.',
                tips: 'Usa este tiempo para fotos de las cascadas desde el barco. La mejor vista de las 7 Hermanas es desde el agua.',
                keyDetails: 'Duración 1h 05m.',
                priceNOK: 585, priceEUR: 50, type: 'transport', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/geirangerfjord/'
            },
            {
                id: '5', title: 'Llegada y Almuerzo Rápido', startTime: '12:05', endTime: '12:45',
                locationName: 'Puerto Geiranger', coords: COORDS.GEIRANGER_FERRY_DOCK,
                description: 'Desembarque y preparación para bus.',
                fullDescription: 'Dirígete directamente a la parada del Bus Panorámico (suele estar justo en el puerto o al lado del centro de información). Come algo rápido para aprovechar el tiempo.',
                tips: 'Localiza la parada del bus nada más bajar para no correr luego.',
                keyDetails: 'Parada Bus cercana.',
                priceNOK: 0, priceEUR: 0, type: 'food', completed: false,
                webcamUrl: 'https://www.youtube.com/live/kRbPEg89tjA?si=6jGdBWjM964b-mg6'
            },
            {
                id: '6', title: 'Tour Panorámico BUS', startTime: '12:45', endTime: '14:15',
                locationName: 'Geiranger', endLocationName: 'Miradores',
                coords: COORDS.GEIRANGER_FERRY_DOCK, endCoords: COORDS.FLYDAL,
                description: 'Flydalsjuvet y Ørnesvingen.',
                fullDescription: '¡La mejor vista! El bus sube a los puntos más icónicos: Flydalsjuvet (la foto clásica del fiordo) y Ørnesvingen (la carretera de las Águilas).',
                tips: 'Accesibilidad: El tour es ideal para evitar escaleras. Las paradas de 10 min en miradores suelen tener plataformas accesibles.',
                keyDetails: 'Tour 1.5 horas.',
                priceNOK: 550, priceEUR: 47, type: 'sightseeing', completed: false,
                ticketUrl: 'https://www.geirangerfjord.no/panoramic-bus-geiranger-4',
                instagramUrl: 'https://www.instagram.com/explore/tags/flydalsjuvet/'
            },
            {
                id: '7', title: 'Almuerzo Relax Geiranger', startTime: '14:15', endTime: '16:00',
                locationName: 'Geiranger Centro', coords: COORDS.GEIRANGER_FERRY_DOCK,
                description: 'Comida tranquila con vistas.',
                fullDescription: 'Disfruta de una comida tranquila en Geiranger. Hay restaurantes con terraza cerca del fiordo.',
                tips: 'Relájate después del bus. Prueba el salmón local.',
                keyDetails: 'Tiempo libre.',
                priceNOK: 350, priceEUR: 30, type: 'food', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/geiranger/'
            },
            {
                id: '8', title: 'Visita Cultural / Paseo', startTime: '16:00', endTime: '18:00',
                locationName: 'Fossevandring', coords: COORDS.FOSSEVANDRING_VIEW,
                description: 'Waterfall Walk o Compras.',
                fullDescription: 'Opción Activa: Sube por el sendero "Fossevandring" (Waterfall Walk) junto a la cascada Storfossen. Opción Relax: Paseo por el puerto.',
                tips: 'El Waterfall Walk tiene escaleras (327 escalones) pero vistas increíbles. Inicia cerca del Hotel Union o desde el puerto subiendo.',
                keyDetails: '2 horas libres.',
                priceNOK: 0, priceEUR: 0, type: 'sightseeing', completed: false,
                instagramUrl: 'https://www.instagram.com/explore/tags/fossevandring/'
            },
            {
                id: '9', title: 'Embarque Ferry (VUELTA)', startTime: '18:00', endTime: '18:30',
                locationName: 'Muelle Geiranger', coords: COORDS.GEIRANGER_FERRY_DOCK,
                description: 'Regreso a Hellesylt.',
                fullDescription: 'Dirígete al muelle para tomar el ferry de vuelta.',
                tips: 'La luz de la tarde (18:30) es ideal para fotografiar los acantilados y granjas abandonadas con iluminación lateral.',
                keyDetails: 'Salida 18:30.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false
            },
            {
                id: '10', title: 'Navegación de Regreso', startTime: '18:30', endTime: '19:35',
                locationName: 'Fiordo', endLocationName: 'Hellesylt',
                coords: COORDS.GEIRANGER_FERRY_DOCK, endCoords: COORDS.HELLESYLT_FERRY_DOCK,
                description: 'Ferry Geiranger -> Hellesylt.',
                fullDescription: 'Disfruta del viaje de vuelta con una perspectiva diferente y luz de atardecer.',
                tips: 'Relájate en cubierta.',
                keyDetails: 'Llegada 19:35.',
                priceNOK: 0, priceEUR: 0, type: 'transport', completed: false
            },
            {
                id: '11', title: 'Llegada y Tiempo Libre', startTime: '19:35', endTime: '20:30',
                locationName: 'Hellesylt', coords: COORDS.HELLESYLT_CRUISE_DOCK,
                description: 'Llegada a Hellesylt y tiempo libre.',
                fullDescription: 'Llegada del ferry de vuelta. Tiempo libre para pasear o volver al barco.',
                tips: 'Mantente cerca del muelle de cruceros.',
                keyDetails: 'Hasta 20:30.',
                priceNOK: 0, priceEUR: 0, type: 'sightseeing', completed: false
            },
            {
                id: '12', title: '¡TODOS A BORDO!', startTime: '20:30', endTime: '20:30',
                locationName: 'Muelle Crucero MSC', coords: COORDS.HELLESYLT_CRUISE_DOCK,
                description: 'Hora límite para embarcar.',
                fullDescription: 'Todos los pasajeros deben estar a bordo. Hora límite 20:30.',
                tips: 'Sube al barco con antelación.',
                keyDetails: 'LÍMITE 20:30.',
                priceNOK: 0, priceEUR: 0, type: 'logistics', completed: false, notes: 'CRITICAL'
            },
            {
                id: '13', title: 'ZARPAMOS', startTime: '21:00', endTime: '21:00',
                locationName: 'Fiordo', coords: COORDS.HELLESYLT_CRUISE_DOCK,
                description: 'Salida del MSC Euribia.',
                fullDescription: 'El barco zarpa hacia el siguiente destino. Despedida de Hellesylt.',
                tips: 'Sube a cubierta para las vistas de despedida.',
                keyDetails: 'Salida 21:00.',
                priceNOK: 0, priceEUR: 0, type: 'transport', completed: false
            }
        ];

        const PRONUNCIATIONS = [
            { word: 'Hellesylt', phonetic: '/hɛləsʏlt/', simplified: 'HE-le-sült', meaning: 'Meseta sagrada' },
            { word: 'Geiranger', phonetic: '/gɛɪrɑŋər/', simplified: 'GAY-rang-er', meaning: 'Fiordo de la lanza' },
            { word: 'Flydalsjuvet', phonetic: '/flyːdɑlsjʉːvət/', simplified: 'FLÜ-dals-iu-vet', meaning: 'Garganta de Flydal' },
            { word: 'Ørnesvingen', phonetic: '/œrnsvɪŋən/', simplified: 'ERN-sving-en', meaning: 'Curva del Águila' },
            { word: 'Fjord', phonetic: '/fjɔːr/', simplified: 'FIURD', meaning: 'Fiordo' },
            { word: 'Foss', phonetic: '/fɔs/', simplified: 'FOS', meaning: 'Cascada' },
            { word: 'Takk', phonetic: '/tak/', simplified: 'TAK', meaning: 'Gracias' },
        ];

        // --- UTILS ---
        const calculateDistance = (c1, c2) => {
            if(!c1 || !c2) return 0;
            const R = 6371e3; 
            const φ1 = c1.lat * Math.PI/180;
            const φ2 = c2.lat * Math.PI/180;
            const Δφ = (c2.lat-c1.lat) * Math.PI/180;
            const Δλ = (c2.lng-c1.lng) * Math.PI/180;
            const a = Math.sin(Δφ/2)*Math.sin(Δφ/2) + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)*Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        };

        const formatDistance = (meters) => {
            if (meters < 1000) return `${Math.round(meters)} m`;
            return `${(meters / 1000).toFixed(1)} km`;
        };

        const calculateDuration = (start, end) => {
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            let diff = (eh*60+em) - (sh*60+sm);
            if(diff < 0) diff += 24*60;
            const h = Math.floor(diff/60);
            const m = diff%60;
            return h > 0 && m > 0 ? `${h}h ${m}m` : (h > 0 ? `${h}h` : `${m} min`);
        };

        const calculateTimeGap = (endPrevious, startNext) => {
            const [eh, em] = endPrevious.split(':').map(Number);
            const [sh, sm] = startNext.split(':').map(Number);
            let diff = (sh*60+sm) - (eh*60+em);
            if (diff <= 0) return null;
            return diff < 60 ? `${diff} min` : `${Math.floor(diff/60)}h ${diff%60}m`;
        };

        const formatTimeRemaining = (targetTimeStr) => {
            const now = new Date();
            const [h, m] = targetTimeStr.split(':').map(Number);
            const target = new Date(now); target.setHours(h, m, 0, 0);
            if(target < now) return "Terminado";
            const diffMs = target - now;
            const dh = Math.floor(diffMs/(1000*60*60));
            const dm = Math.floor((diffMs%(1000*60*60))/(1000*60));
            return dh > 0 ? `${dh}h ${dm}m` : `${dm}m`;
        };

        // --- COMPONENTS ---

        const ActivityDetailModal = ({ activity, onClose, onOpenAudio }) => {
            if (!activity) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh] modal-content">
                        {/* Header */}
                        <div className="bg-fjord-500 p-4 text-white relative">
                            <h3 className="text-xl font-bold pr-8">{activity.title}</h3>
                            <div className="flex items-center text-fjord-100 text-sm mt-1">
                                <Clock size={14} className="mr-1" />
                                {activity.startTime} - {activity.endTime}
                            </div>
                            <button onClick={onClose} className="absolute top-4 right-4 text-white/80 hover:text-white bg-white/10 rounded-full p-1">
                                <X size={20} />
                            </button>
                        </div>
                        
                        {/* Content */}
                        <div className="p-5 overflow-y-auto">
                            <div className="mb-4">
                                <h4 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Descripción</h4>
                                <p className="text-gray-700 leading-relaxed">{activity.fullDescription || activity.description}</p>
                            </div>
                            
                            <div className="mb-4 bg-orange-50 p-3 rounded-lg border border-orange-100">
                                <h4 className="text-xs font-bold text-orange-600 uppercase tracking-wider mb-1 flex items-center">
                                    <Lightbulb size={12} className="mr-1" /> Consejo Pro
                                </h4>
                                <p className="text-sm text-orange-800 italic whitespace-pre-wrap">{activity.tips}</p>
                            </div>

                            {/* Audio Guide Button */}
                            {activity.hasAudioGuide && (
                                <button 
                                    onClick={() => onOpenAudio()}
                                    className="flex items-center justify-center w-full mb-4 p-4 rounded-xl bg-slate-800 text-white font-bold shadow-lg hover:bg-slate-900 transition-all active:scale-95 border border-slate-700"
                                >
                                    <Headphones className="mr-3 text-emerald-400" size={24} />
                                    <div>
                                        <div className="leading-none">Escuchar Audioguía</div>
                                        <div className="text-[10px] font-normal text-slate-400 mt-1">5 Pistas - Narración Local</div>
                                    </div>
                                </button>
                            )}
                            
                            {/* Instagram Button */}
                            {activity.instagramUrl && (
                                <a href={activity.instagramUrl} target="_blank" rel="noopener noreferrer" 
                                   className="flex items-center justify-center w-full mb-4 p-3 rounded-xl bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 text-white font-bold shadow-md hover:shadow-lg transition-all active:scale-95">
                                    <Instagram className="mr-2" size={20} />
                                    Ver Fotos en Instagram
                                </a>
                            )}
                            
                            {/* Actions */}
                            <div className="space-y-3 pt-2">
                                {activity.webcamUrl && (
                                    <a href={activity.webcamUrl} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full p-3 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 transition-colors">
                                        <Camera className="mr-2" size={18} />
                                        Ver Webcam en Vivo
                                    </a>
                                )}
                                
                                {activity.ticketUrl && (
                                    <a href={activity.ticketUrl} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center w-full p-3 bg-emerald-600 text-white rounded-xl font-bold shadow-md hover:bg-emerald-700 transition-colors">
                                        <Ticket className="mr-2" size={18} />
                                        Comprar Tickets Online
                                    </a>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AudioGuideModal = ({ onClose }) => {
            const [currentTrack, setCurrentTrack] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);

            const playTrack = (track) => {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(track.text);
                utterance.lang = 'es-ES';
                utterance.rate = 1.0;
                
                utterance.onend = () => {
                    setIsPlaying(false);
                    setCurrentTrack(null);
                };
                
                window.speechSynthesis.speak(utterance);
                setCurrentTrack(track.id);
                setIsPlaying(true);
            };

            const stopTrack = () => {
                window.speechSynthesis.cancel();
                setIsPlaying(false);
                setCurrentTrack(null);
            };

            useEffect(() => {
                return () => window.speechSynthesis.cancel();
            }, []);

            return (
                <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-slate-900 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh] modal-content border border-slate-700">
                        {/* Header */}
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-950">
                            <div className="flex items-center text-white">
                                <Headphones className="mr-2 text-emerald-400" />
                                <h3 className="font-bold text-lg">Audioguía Hellesylt</h3>
                            </div>
                            <button onClick={onClose} className="p-1 text-slate-400 hover:text-white"><X size={20}/></button>
                        </div>

                        {/* Player Content */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-3">
                            {HELLESYLT_AUDIO_TRACKS.map((track) => {
                                const isActive = currentTrack === track.id;
                                return (
                                    <div key={track.id} className={`rounded-xl p-3 border transition-all ${isActive ? 'bg-slate-800 border-emerald-500 shadow-emerald-900/20 shadow-lg' : 'bg-slate-800/50 border-slate-700 hover:bg-slate-800'}`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <h4 className={`font-bold text-sm ${isActive ? 'text-emerald-400' : 'text-slate-200'}`}>{track.title}</h4>
                                            <button 
                                                onClick={() => isActive && isPlaying ? stopTrack() : playTrack(track)}
                                                className={`p-2 rounded-full ${isActive && isPlaying ? 'bg-red-500/20 text-red-400' : 'bg-emerald-500/20 text-emerald-400'}`}
                                            >
                                                {isActive && isPlaying ? <StopCircle size={20}/> : <Play size={20}/>}
                                            </button>
                                        </div>
                                        {isActive && (
                                            <div className="mt-2 pt-2 border-t border-slate-700">
                                                <p className="text-xs text-slate-300 leading-relaxed font-serif animate-in fade-in">{track.text}</p>
                                                <div className="flex items-center justify-center mt-3 space-x-2">
                                                    <span className="flex h-2 w-2 relative">
                                                      <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                                      <span className="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                                    </span>
                                                    <span className="text-[10px] uppercase font-bold text-emerald-500 tracking-wider">Reproduciendo...</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                        
                        <div className="p-3 bg-slate-950 text-center text-[10px] text-slate-500">
                            *El audio se genera usando la síntesis de voz de tu dispositivo.
                        </div>
                    </div>
                </div>
            );
        };

        const Timeline = ({ itinerary, onToggleComplete, onLocate, userLocation, onSelectActivity }) => {
            const now = new Date();
            const currentTimeMinutes = now.getHours() * 60 + now.getMinutes();
            
            return (
                <div className="pb-24 px-4 pt-4 max-w-lg mx-auto">
                    <h2 className="text-2xl font-bold text-fjord-500 mb-2">Itinerario Panorámico</h2>
                    <p className="text-xs text-slate-500 mb-6 flex items-center">
                        <Info size={12} className="mr-1"/> Toca una tarjeta para ver detalles
                    </p>
                    
                    <div className="relative border-l-2 border-slate-200 ml-3">
                        {itinerary.map((act, index) => {
                            const [sh, sm] = act.startTime.split(':').map(Number);
                            const [eh, em] = act.endTime.split(':').map(Number);
                            const startMinutes = sh * 60 + sm;
                            const endMinutes = eh * 60 + em;
                            
                            // Status Checks
                            const isActive = currentTimeMinutes >= startMinutes && currentTimeMinutes < endMinutes;
                            const isPast = currentTimeMinutes >= endMinutes;
                            const isCritical = act.notes === 'CRITICAL';
                            const duration = calculateDuration(act.startTime, act.endTime);
                            
                            // Calculate Gap to next activity
                            let gapElement = null;
                            if (index < itinerary.length - 1) {
                                const nextAct = itinerary[index + 1];
                                const gap = calculateTimeGap(act.endTime, nextAct.startTime);
                                if (gap) {
                                    // Check if NOW is in the gap
                                    const [nsh, nsm] = nextAct.startTime.split(':').map(Number);
                                    const nextStartMinutes = nsh * 60 + nsm;
                                    const isGapNow = currentTimeMinutes >= endMinutes && currentTimeMinutes < nextStartMinutes;

                                    gapElement = (
                                        <div className="relative pl-6 py-4">
                                            {isGapNow && (
                                                <div className="absolute left-[-6px] top-1/2 -translate-y-1/2 w-full flex items-center z-10">
                                                    <div className="w-3 h-3 bg-red-500 rounded-full border-2 border-white shadow"></div>
                                                    <div className="h-[2px] bg-red-500 w-full opacity-50"></div>
                                                    <span className="absolute right-0 bg-red-500 text-white text-[10px] px-2 py-0.5 rounded font-bold">
                                                        AHORA {now.getHours()}:{String(now.getMinutes()).padStart(2,'0')}
                                                    </span>
                                                </div>
                                            )}
                                            <div className="flex items-center justify-center">
                                                <span className="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded-full border border-slate-200 flex items-center">
                                                    <ChevronDown size={12} className="mr-1" />
                                                    {gap} traslado / libre
                                                </span>
                                            </div>
                                        </div>
                                    );
                                }
                            }

                            // Calculate Progress if Active
                            let progress = 0;
                            if (isActive) {
                                const totalDuration = endMinutes - startMinutes;
                                const elapsed = currentTimeMinutes - startMinutes;
                                progress = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
                            }

                            return (
                                <React.Fragment key={act.id}>
                                    <div className="pl-6 relative group">
                                        {/* Dot */}
                                        <div 
                                            className={`absolute -left-[9px] top-4 w-5 h-5 rounded-full border-4 cursor-pointer transition-all bg-white z-10 ${
                                                act.completed ? 'border-emerald-500' : isActive ? 'border-blue-500 scale-125' : 'border-slate-300'
                                            }`}
                                            onClick={(e) => { e.stopPropagation(); onToggleComplete(act.id); }}
                                        >
                                            {act.completed && <div className="w-full h-full bg-emerald-500 rounded-full scale-50" />}
                                        </div>

                                        {/* Card */}
                                        <div 
                                            onClick={() => onSelectActivity(act)}
                                            className={`
                                                relative p-4 rounded-xl border shadow-sm transition-all cursor-pointer overflow-hidden
                                                ${isActive ? 'bg-white border-blue-400 ring-2 ring-blue-100 shadow-blue-100' : 'bg-white border-slate-200 hover:border-blue-300'}
                                                ${act.completed ? 'opacity-70 bg-slate-50' : ''}
                                                ${isCritical ? 'bg-red-50 border-red-200' : ''}
                                            `}
                                        >
                                            {isActive && (
                                                <div className="absolute top-0 left-0 w-full h-1 bg-blue-100">
                                                    <div className="h-full bg-blue-500 transition-all duration-1000" style={{ width: `${progress}%` }}></div>
                                                </div>
                                            )}

                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <div className="flex items-center space-x-2 mb-1">
                                                        <span className={`text-xs font-bold px-1.5 py-0.5 rounded ${isActive ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600'}`}>
                                                            {act.startTime} - {act.endTime}
                                                        </span>
                                                        <span className="text-xs text-slate-400 font-medium">{duration}</span>
                                                        {isActive && <span className="text-[10px] font-bold text-blue-600 animate-pulse">⚡ EN CURSO</span>}
                                                    </div>
                                                    <h3 className={`font-bold text-lg leading-tight ${isCritical ? 'text-red-700' : 'text-slate-800'}`}>
                                                        {act.title}
                                                    </h3>
                                                </div>
                                                <div className="flex gap-2 pl-2 items-center">
                                                    {act.hasAudioGuide && <Headphones size={18} className="text-emerald-500" />}
                                                    {act.webcamUrl && (
                                                        <span className="text-[10px] font-bold bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded border border-blue-200">
                                                            WEBCAM
                                                        </span>
                                                    )}
                                                    {act.ticketUrl && <Ticket size={18} className="text-emerald-500" />}
                                                    {isCritical && <AlertTriangle size={20} className="text-red-500" />}
                                                </div>
                                            </div>

                                            <p className="text-sm text-slate-600 line-clamp-2 mb-2">{act.description}</p>

                                            <div className="flex items-center justify-between mt-2 pt-2 border-t border-slate-100">
                                                <div className="flex items-center text-xs text-slate-500">
                                                    <MapPin size={12} className="mr-1" />
                                                    {act.locationName}
                                                    {userLocation && (
                                                        <span className="ml-2 text-blue-600 font-medium">
                                                            ({formatDistance(calculateDistance(userLocation, act.coords))})
                                                        </span>
                                                    )}
                                                </div>
                                                
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); onLocate(act.coords, act.endCoords); }}
                                                    className="p-1.5 hover:bg-slate-100 rounded-full text-fjord-600"
                                                >
                                                    <MapIcon size={16} />
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {gapElement}
                                </React.Fragment>
                            );
                        })}
                        
                        {/* Copyright Footer */}
                        <div className="text-center py-8 text-slate-400 text-xs mt-4">
                            <p className="font-medium">Hellesylt Guide 2026</p>
                            <p>Actualizado el {UPDATE_DATE}</p>
                            <p className="mt-1">© 2025 - 2026 Gonzalo Arenas de la Hoz</p>
                        </div>
                    </div>
                </div>
            );
        };

        const Budget = ({ itinerary }) => {
            const [currency, setCurrency] = useState('NOK'); // Default NOK
            const [rate, setRate] = useState(11.8); // Default fallback rate
            const [calcAmount, setCalcAmount] = useState('');
            const [calcMode, setCalcMode] = useState('NOK_TO_EUR'); // Default NOK to EUR
            
            // Toggle completed items for budget
            const [paidItems, setPaidItems] = useState([]); // Default UNCHECKED

            // Manual Expenses
            const [customExpenses, setCustomExpenses] = useState([]);
            const [newExpName, setNewExpName] = useState('');
            const [newExpCost, setNewExpCost] = useState('');
            const [isAddOpen, setIsAddOpen] = useState(false);

            // Fetch Live Rate
            useEffect(() => {
                fetch('https://api.exchangerate-api.com/v4/latest/EUR')
                    .then(res => res.json())
                    .then(data => {
                        if(data && data.rates && data.rates.NOK) {
                            setRate(data.rates.NOK);
                        }
                    })
                    .catch(err => console.log('Using offline rate'));
            }, []);

            const togglePaid = (id) => {
                if (paidItems.includes(id)) {
                    setPaidItems(paidItems.filter(i => i !== id));
                } else {
                    setPaidItems([...paidItems, id]);
                }
            };

            const addCustomExpense = () => {
                if(!newExpName || !newExpCost) return;
                const cost = parseFloat(newExpCost);
                if(isNaN(cost)) return;

                const newExp = {
                    id: 'cust_' + Date.now(),
                    title: newExpName,
                    priceNOK: currency === 'NOK' ? cost : cost * rate,
                    priceEUR: currency === 'EUR' ? cost : cost / rate,
                    type: 'extra'
                };
                
                setCustomExpenses([...customExpenses, newExp]);
                setNewExpName('');
                setNewExpCost('');
                setIsAddOpen(false);
            };
            
            const removeCustomExpense = (id) => {
                setCustomExpenses(customExpenses.filter(e => e.id !== id));
            };

            const stats = useMemo(() => {
                const totalEUR_Plan = itinerary.reduce((sum, item) => sum + item.priceEUR, 0);
                const totalEUR_Custom = customExpenses.reduce((sum, item) => sum + item.priceEUR, 0);
                
                const spentEUR_Plan = itinerary
                    .filter(item => paidItems.includes(item.id))
                    .reduce((sum, item) => sum + item.priceEUR, 0);
                
                const totalEUR = totalEUR_Plan + totalEUR_Custom;
                const currentEUR = spentEUR_Plan + totalEUR_Custom;
                
                return {
                    total: currency === 'EUR' ? totalEUR : totalEUR * rate,
                    current: currency === 'EUR' ? currentEUR : currentEUR * rate,
                    pending: currency === 'EUR' ? (totalEUR - currentEUR) : (totalEUR - currentEUR) * rate
                };
            }, [itinerary, paidItems, currency, rate, customExpenses]);

            // Conversion logic
            const convertedValue = useMemo(() => {
                const val = parseFloat(calcAmount);
                if (isNaN(val)) return '---';
                if (calcMode === 'EUR_TO_NOK') return (val * rate).toFixed(2) + ' kr';
                return (val / rate).toFixed(2) + ' €';
            }, [calcAmount, calcMode, rate]);

            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto">
                    {/* Header & Currency Toggle */}
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-fjord-500 flex items-center">
                            <Wallet className="mr-2" /> Gastos
                        </h2>
                        <div className="flex bg-slate-200 rounded-lg p-1">
                            <button onClick={() => setCurrency('EUR')} className={`px-3 py-1 text-sm rounded-md font-bold transition-all ${currency === 'EUR' ? 'bg-white shadow text-fjord-600' : 'text-slate-500'}`}>EUR</button>
                            <button onClick={() => setCurrency('NOK')} className={`px-3 py-1 text-sm rounded-md font-bold transition-all ${currency === 'NOK' ? 'bg-white shadow text-fjord-600' : 'text-slate-500'}`}>NOK</button>
                        </div>
                    </div>

                    {/* Converter Tool */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-xs font-bold text-slate-400 uppercase flex items-center">
                                <Calculator size={12} className="mr-1"/> Conversor (1€ ≈ {rate.toFixed(2)} kr)
                            </h3>
                            <button onClick={() => setCalcMode(prev => prev === 'EUR_TO_NOK' ? 'NOK_TO_EUR' : 'EUR_TO_NOK')} className="p-1 bg-slate-100 rounded hover:bg-slate-200">
                                <ArrowRightLeft size={14} className="text-slate-600" />
                            </button>
                        </div>
                        <div className="flex items-center space-x-2">
                            <div className="relative flex-1">
                                <input 
                                    type="number" 
                                    value={calcAmount}
                                    onChange={(e) => setCalcAmount(e.target.value)}
                                    placeholder="Cantidad"
                                    className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg font-mono text-lg outline-none focus:border-fjord-500"
                                />
                                <span className="absolute right-3 top-1/2 -translate-y-1/2 text-sm text-slate-400 font-bold">
                                    {calcMode === 'EUR_TO_NOK' ? '€' : 'kr'}
                                </span>
                            </div>
                            <div className="text-slate-400"><ArrowRight size={16}/></div>
                            <div className="flex-1 p-2 bg-fjord-50 border border-fjord-100 rounded-lg text-lg font-bold text-fjord-700 text-center">
                                {convertedValue}
                            </div>
                        </div>
                    </div>

                    {/* Big Stats Card */}
                    <div className="bg-gradient-to-r from-fjord-600 to-fjord-800 rounded-2xl p-6 text-white shadow-xl mb-6 relative overflow-hidden">
                        <div className="absolute top-0 right-0 p-4 opacity-10"><Wallet size={100}/></div>
                        <div className="relative z-10">
                            <p className="text-fjord-200 text-xs font-bold uppercase tracking-wider mb-1">Gasto Realizado</p>
                            <div className="text-4xl font-bold mb-2">
                                {currency === 'EUR' ? '€' : ''}{stats.current.toFixed(0)}{currency === 'NOK' ? ' kr' : ''}
                            </div>
                            <div className="w-full bg-black/20 h-2 rounded-full mb-2">
                                <div className="bg-emerald-400 h-full rounded-full transition-all duration-500" style={{ width: `${Math.min(100, (stats.current / stats.total) * 100)}%` }}></div>
                            </div>
                            <div className="flex justify-between text-xs text-fjord-100 font-medium">
                                <span>Total Planificado: {stats.total.toFixed(0)}</span>
                                <span>Pendiente: {stats.pending.toFixed(0)}</span>
                            </div>
                        </div>
                    </div>

                    {/* Manual Expense Input */}
                    {!isAddOpen ? (
                        <button 
                            onClick={() => setIsAddOpen(true)}
                            className="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-500 font-bold mb-6 flex items-center justify-center hover:bg-slate-50 hover:border-slate-400 transition-colors"
                        >
                            <Plus size={20} className="mr-2"/> Añadir Gasto Extra
                        </button>
                    ) : (
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6 animate-in fade-in slide-in-from-top-2">
                             <div className="flex justify-between items-center mb-2">
                                <h4 className="font-bold text-sm text-slate-700">Nuevo Gasto</h4>
                                <button onClick={() => setIsAddOpen(false)}><X size={18} className="text-slate-400"/></button>
                             </div>
                             <div className="space-y-3">
                                <input 
                                    type="text" placeholder="Concepto (ej: Imán)" 
                                    className="w-full p-2 rounded border border-slate-300 text-sm"
                                    value={newExpName} onChange={e => setNewExpName(e.target.value)}
                                />
                                <div className="flex space-x-2">
                                    <input 
                                        type="number" placeholder="Precio" 
                                        className="flex-1 p-2 rounded border border-slate-300 text-sm"
                                        value={newExpCost} onChange={e => setNewExpCost(e.target.value)}
                                    />
                                    <div className="flex items-center bg-white px-3 border border-slate-300 rounded text-sm font-bold text-slate-500">
                                        {currency}
                                    </div>
                                </div>
                                <button 
                                    onClick={addCustomExpense}
                                    className="w-full bg-fjord-600 text-white py-2 rounded-lg font-bold text-sm shadow hover:bg-fjord-700"
                                >
                                    Guardar
                                </button>
                             </div>
                        </div>
                    )}

                    {/* Interactive List */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                        {/* Custom Expenses List */}
                        {customExpenses.map((item) => (
                             <div 
                                key={item.id} 
                                className="flex items-center justify-between p-4 border-b border-slate-50 bg-yellow-50/50"
                            >
                                <div className="flex items-center">
                                    <div className="w-5 h-5 rounded border border-emerald-500 bg-emerald-500 mr-3 flex items-center justify-center">
                                        <CheckCircle2 size={14} className="text-white" />
                                    </div>
                                    <div>
                                        <p className="font-medium text-slate-800">{item.title}</p>
                                        <p className="text-xs text-slate-400 italic">Extra Manual</p>
                                    </div>
                                </div>
                                <div className="flex items-center">
                                    <div className="font-bold font-mono text-fjord-600 mr-3">
                                        {currency === 'EUR' ? `€${item.priceEUR.toFixed(0)}` : `${item.priceNOK.toFixed(0)} kr`}
                                    </div>
                                    <button onClick={() => removeCustomExpense(item.id)} className="text-red-400 hover:text-red-600">
                                        <Trash2 size={16}/>
                                    </button>
                                </div>
                            </div>
                        ))}

                        {/* Planned Itinerary List */}
                        {itinerary.filter(i => i.priceEUR > 0).map((item) => (
                            <div 
                                key={item.id} 
                                onClick={() => togglePaid(item.id)}
                                className="flex items-center justify-between p-4 border-b border-slate-50 last:border-0 hover:bg-slate-50 cursor-pointer transition-colors"
                            >
                                <div className="flex items-center">
                                    <div className={`w-5 h-5 rounded border mr-3 flex items-center justify-center transition-colors ${paidItems.includes(item.id) ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300 bg-white'}`}>
                                        {paidItems.includes(item.id) && <CheckCircle2 size={14} className="text-white" />}
                                    </div>
                                    <div>
                                        <p className={`font-medium ${paidItems.includes(item.id) ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{item.title}</p>
                                        <p className="text-xs text-slate-400 capitalize">{item.type}</p>
                                    </div>
                                </div>
                                <div className={`font-bold font-mono ${paidItems.includes(item.id) ? 'text-slate-400' : 'text-fjord-600'}`}>
                                    {currency === 'EUR' ? `€${item.priceEUR}` : `${item.priceNOK} kr`}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Guide = ({ userLocation }) => {
            const [playing, setPlaying] = useState(null);
            const [weather, setWeather] = useState(null);
            const [forecast, setForecast] = useState([]);
            const [hourlyForecast, setHourlyForecast] = useState([]);
            const [astronomy, setAstronomy] = useState(null);
            const [showRainGuide, setShowRainGuide] = useState(false);

            // Fetch Weather & Solar Data
            useEffect(() => {
                // Weather for Hellesylt/Geiranger (Lat 62.08)
                fetch('https://api.open-meteo.com/v1/forecast?latitude=62.08&longitude=6.86&current=temperature_2m,weather_code,is_day&hourly=temperature_2m,precipitation_probability,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Europe%2FBerlin&forecast_days=5')
                    .then(res => res.json())
                    .then(data => {
                        setWeather(data);
                        
                        // Process Hourly (09:00 - 20:00 for today)
                        if (data.hourly) {
                            const hourly = [];
                            // Loop through first 24 indices (Today)
                            for(let i = 0; i < 24; i++) {
                                const timeStr = data.hourly.time[i]; 
                                const hourStr = timeStr.split('T')[1].split(':')[0];
                                const hour = parseInt(hourStr, 10);
                                
                                if (hour >= 9 && hour <= 20) {
                                    hourly.push({
                                        time: `${hourStr}:00`,
                                        temp: Math.round(data.hourly.temperature_2m[i]),
                                        precip: data.hourly.precipitation_probability[i],
                                        code: data.hourly.weather_code[i]
                                    });
                                }
                            }
                            setHourlyForecast(hourly);
                        }

                        // Process 5-day forecast
                        if(data.daily) {
                            const days = data.daily.time.map((t, i) => ({
                                date: t,
                                max: data.daily.temperature_2m_max[i],
                                min: data.daily.temperature_2m_min[i],
                                code: data.daily.weather_code[i]
                            }));
                            setForecast(days);
                        }
                    })
                    .catch(e => console.log('Weather offline'));

                // Solar/Astronomy
                fetch('https://api.open-meteo.com/v1/forecast?latitude=62.08&longitude=6.86&daily=sunrise,sunset,daylight_duration&timezone=Europe%2FBerlin&forecast_days=1')
                    .then(res => res.json())
                    .then(data => {
                        if (data.daily) {
                            setAstronomy({
                                sunrise: data.daily.sunrise[0], // ISO String
                                sunset: data.daily.sunset[0],   // ISO String
                                duration: (data.daily.daylight_duration[0] / 3600).toFixed(1)
                            });
                        }
                    })
                    .catch(e => console.log("Astronomy offline"));
            }, []);

            const playAudio = (text) => {
                if ('speechSynthesis' in window) {
                    setPlaying(text);
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'no-NO'; // Norwegian
                    utterance.rate = 0.9;
                    utterance.onend = () => setPlaying(null);
                    window.speechSynthesis.speak(utterance);
                } else {
                    alert("Tu navegador no soporta audio.");
                }
            };

            const getWeatherIcon = (code) => {
                if (code <= 3) return <Sun className="text-yellow-500" />;
                if (code <= 60) return <CloudRain className="text-blue-400" />;
                return <CloudSnow className="text-gray-400" />;
            };

            const handleSOS = () => {
                if (!userLocation) {
                    alert("Necesitamos tu ubicación primero. Asegúrate de tener el GPS activo.");
                    return;
                }
                const text = `🆘 SOS! Necesito ayuda. Mi ubicación actual en Hellesylt/Geiranger es: https://maps.google.com/?q=${userLocation.lat},${userLocation.lng}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            };

            const openTranslator = () => {
                window.open('https://translate.google.com/?sl=no&tl=es&op=images', '_blank');
            };
            
            const openMSCApp = () => {
                window.open('https://play.google.com/store/apps/details?id=com.msccruises.mscforme', '_blank');
            };

            // Solar Chart Helper
            const renderSolarChart = () => {
                if (!astronomy) return <div className="text-xs text-slate-400">Cargando datos solares...</div>;

                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const totalMinutes = 24 * 60;
                const nowPercent = (currentMinutes / totalMinutes) * 100;

                const sunriseDate = new Date(astronomy.sunrise);
                const sunsetDate = new Date(astronomy.sunset);
                
                const sunriseMins = sunriseDate.getHours() * 60 + sunriseDate.getMinutes();
                const sunsetMins = sunsetDate.getHours() * 60 + sunsetDate.getMinutes();
                
                const sunrisePercent = (sunriseMins / totalMinutes) * 100;
                const sunsetPercent = (sunsetMins / totalMinutes) * 100;

                const sunriseStr = `${String(sunriseDate.getHours()).padStart(2,'0')}:${String(sunriseDate.getMinutes()).padStart(2,'0')}`;
                const sunsetStr = `${String(sunsetDate.getHours()).padStart(2,'0')}:${String(sunsetDate.getMinutes()).padStart(2,'0')}`;

                return (
                    <div className="mt-4 bg-slate-900 rounded-xl p-4 text-white relative overflow-hidden shadow-inner">
                        <div className="flex justify-between text-xs text-slate-400 mb-6 font-mono">
                            <span>00:00</span>
                            <span>12:00</span>
                            <span>23:59</span>
                        </div>
                        
                        {/* The Bar Container */}
                        <div className="relative h-12 w-full rounded-full bg-slate-800 overflow-hidden border border-slate-700">
                            {/* Day Segment (Blue) */}
                            <div 
                                className="absolute top-0 bottom-0 bg-sky-400"
                                style={{ 
                                    left: `${sunrisePercent}%`, 
                                    width: `${sunsetPercent - sunrisePercent}%` 
                                }}
                            ></div>

                            {/* Sunrise Gradient Overlay */}
                            <div 
                                className="absolute top-0 bottom-0 w-8 -ml-4 bg-gradient-to-r from-slate-800 via-orange-400 to-sky-400 opacity-90"
                                style={{ left: `${sunrisePercent}%` }}
                            ></div>

                            {/* Sunset Gradient Overlay */}
                            <div 
                                className="absolute top-0 bottom-0 w-8 -ml-4 bg-gradient-to-r from-sky-400 via-orange-500 to-slate-800 opacity-90"
                                style={{ left: `${sunsetPercent}%` }}
                            ></div>
                            
                            {/* NOW Indicator */}
                            <div 
                                className="absolute top-0 bottom-0 w-0.5 bg-red-500 z-10 shadow-[0_0_10px_rgba(239,68,68,0.8)]"
                                style={{ left: `${nowPercent}%` }}
                            >
                                <div className="absolute -top-1 -left-[3px] w-2 h-2 bg-red-500 rounded-full"></div>
                                <div className="absolute top-1/2 -left-6 bg-red-600 text-white text-[9px] font-bold px-1 rounded transform -translate-y-1/2">AHORA</div>
                            </div>
                        </div>

                        {/* Labels positioned absolutely */}
                        <div className="relative h-6 mt-1 w-full text-[10px] font-bold">
                            <div 
                                className="absolute transform -translate-x-1/2 flex flex-col items-center text-yellow-400"
                                style={{ left: `${sunrisePercent}%` }}
                            >
                                <ArrowRight size={10} className="-rotate-90 mb-0.5"/>
                                <span>{sunriseStr}</span>
                            </div>
                            <div 
                                className="absolute transform -translate-x-1/2 flex flex-col items-center text-orange-400"
                                style={{ left: `${sunsetPercent}%` }}
                            >
                                <ArrowRight size={10} className="-rotate-90 mb-0.5"/>
                                <span>{sunsetStr}</span>
                            </div>
                        </div>
                        
                        <div className="mt-4 flex items-center justify-between text-xs text-slate-300 bg-white/5 p-2 rounded">
                            <div className="flex items-center"><Sunrise size={14} className="text-yellow-400 mr-2"/> Amanecer</div>
                            <div className="font-mono">{astronomy.duration}h Luz</div>
                            <div className="flex items-center">Atardecer <Sunset size={14} className="text-orange-500 ml-2"/></div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto">
                    
                    {/* SOS & Apps Buttons */}
                    <div className="grid grid-cols-2 gap-3 mb-4">
                        <button 
                            onClick={handleSOS}
                            className="bg-red-600 text-white p-4 rounded-xl shadow-lg flex flex-col items-center justify-center active:scale-95 transition-transform animate-pulse-slow"
                        >
                            <AlertTriangle size={32} className="mb-2" />
                            <span className="font-bold text-sm">SOS EMERGENCIA</span>
                            <span className="text-[10px] opacity-80 mt-1">Enviar Ubicación</span>
                        </button>
                        
                        <div className="flex flex-col gap-2">
                             <button 
                                onClick={openMSCApp}
                                className="flex-1 bg-blue-900 text-white p-2 rounded-xl shadow flex items-center justify-center active:scale-95"
                            >
                                <Anchor size={20} className="mr-2" />
                                <span className="text-xs font-bold">App MSC</span>
                            </button>
                            <button 
                                onClick={openTranslator}
                                className="flex-1 bg-indigo-600 text-white p-2 rounded-xl shadow flex items-center justify-center active:scale-95"
                            >
                                <Camera size={20} className="mr-2" />
                                <span className="text-xs font-bold">Traductor Visual</span>
                            </button>
                        </div>
                    </div>

                    {/* Rain Guide Button */}
                    <button 
                        onClick={() => setShowRainGuide(true)}
                        className="w-full bg-slate-800 text-white p-3 rounded-xl shadow-md mb-6 flex items-center justify-center space-x-2 active:scale-95 transition-all border border-slate-700"
                    >
                        <Umbrella size={20} className="text-blue-300" />
                        <span className="font-bold">INCLEMENCIA CLIMÁTICA: Plan de Lluvia</span>
                    </button>

                    <h2 className="text-2xl font-bold text-fjord-500 mb-4">Guía Local</h2>

                    {/* Solar Chart */}
                    <div className="mb-8">
                        <h3 className="font-bold text-slate-700 mb-2 flex items-center"><Sun size={18} className="mr-2 text-orange-500"/> Ciclo Solar Hoy</h3>
                        {renderSolarChart()}
                    </div>

                    {/* Hourly Weather Forecast (09:00 - 20:00) */}
                    {hourlyForecast.length > 0 && (
                        <div className="mb-8">
                             <h3 className="font-bold text-slate-700 mb-4 flex items-center"><Clock size={18} className="mr-2 text-blue-500"/> Clima por Horas (09:00 - 20:00)</h3>
                             <div className="flex overflow-x-auto pb-4 space-x-3 snap-x">
                                {hourlyForecast.map((hour, idx) => (
                                    <div key={idx} className="flex-none w-20 bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex flex-col items-center justify-center snap-center">
                                        <span className="text-xs font-bold text-slate-400 mb-2">{hour.time}</span>
                                        <div className="mb-2 scale-125">{getWeatherIcon(hour.code)}</div>
                                        <span className="text-lg font-bold text-slate-800">{hour.temp}°</span>
                                        <div className="flex items-center text-[10px] text-blue-500 font-medium mt-1">
                                            <Droplets size={8} className="mr-1"/> {hour.precip}%
                                        </div>
                                    </div>
                                ))}
                             </div>
                        </div>
                    )}

                    {/* 5-Day Forecast */}
                    <div className="mb-8">
                         <h3 className="font-bold text-slate-700 mb-4 flex items-center"><CloudSun size={18} className="mr-2 text-blue-500"/> Pronóstico 5 Días</h3>
                         <div className="bg-white rounded-xl shadow-sm border border-slate-200 divide-y divide-slate-100">
                            {forecast.length > 0 ? forecast.map((day, i) => {
                                const date = new Date(day.date);
                                const dayName = date.toLocaleDateString('es-ES', { weekday: 'long' });
                                return (
                                    <div key={day.date} className="p-3 flex justify-between items-center">
                                        <span className="capitalize w-24 font-medium text-slate-700">{i===0 ? 'Hoy' : dayName}</span>
                                        <div className="flex items-center">
                                            {getWeatherIcon(day.code)}
                                            <span className="ml-2 text-sm text-slate-500">{day.code <= 3 ? 'Soleado' : 'Nublado'}</span>
                                        </div>
                                        <div className="text-sm font-mono font-bold text-slate-800">
                                            {Math.round(day.max)}° <span className="text-slate-400">/ {Math.round(day.min)}°</span>
                                        </div>
                                    </div>
                                )
                            }) : <div className="p-4 text-center text-slate-400">Cargando clima...</div>}
                         </div>
                    </div>
                    
                    {/* Pronunciation */}
                    <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center"><Volume2 size={18} className="mr-2"/> Diccionario Exprés</h3>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                        {PRONUNCIATIONS.map((item, idx) => (
                        <div key={item.word} className={`p-4 flex justify-between items-center ${idx !== PRONUNCIATIONS.length - 1 ? 'border-b border-slate-50' : ''}`}>
                            <div>
                                <div className="flex items-baseline space-x-2">
                                    <span className="font-bold text-lg text-fjord-700">{item.word}</span>
                                    <span className="text-xs text-slate-400 font-mono bg-slate-100 px-1 rounded">{item.simplified}</span>
                                </div>
                                <p className="text-xs text-slate-500 mt-1 italic">{item.meaning}</p>
                            </div>
                            <button 
                                onClick={() => playAudio(item.word)}
                                className={`p-3 rounded-full transition-colors ${playing === item.word ? 'bg-emerald-100 text-emerald-600 scale-110' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`}
                            >
                            <Volume2 size={20} />
                            </button>
                        </div>
                        ))}
                    </div>

                     {/* Footer */}
                     <div className="text-center py-8 text-slate-400 text-xs">
                        <p className="font-medium">Hellesylt Guide 2026</p>
                        <p>Actualizado el {UPDATE_DATE}</p>
                        <p className="mt-1">© 2025 - 2026 Gonzalo Arenas de la Hoz</p>
                    </div>

                    {/* Rain Guide Modal */}
                    {showRainGuide && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                            <div className="bg-white w-full max-w-lg max-h-[85vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col modal-content">
                                <div className="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0">
                                    <h3 className="font-bold flex items-center text-lg"><CloudRain className="mr-2 text-blue-300"/> Plan Táctico: Lluvia</h3>
                                    <button onClick={() => setShowRainGuide(false)} className="p-1 hover:bg-white/10 rounded-full"><X/></button>
                                </div>
                                <div className="p-5 overflow-y-auto text-slate-700 text-sm leading-relaxed space-y-4">
                                    <p className="italic bg-slate-100 p-3 rounded-lg border-l-4 border-slate-400">
                                        "Cuatro horas (de 14:30 a 18:30) bajo la lluvia en Geiranger pueden hacerse eternas si no tienes un plan, o convertirse en una tarde 'hygge' maravillosa."
                                    </p>
                                    
                                    <div>
                                        <h4 className="font-bold text-fjord-600">14:30 – 15:00: La Ascensión Táctica (Sin mojarse)</h4>
                                        <p className="mt-1">El error de novato: Subir andando por las escaleras bajo la lluvia. Llegarás empapado y sudando.</p>
                                        <p className="mt-1 font-medium">La jugada maestra: Busca el autobús "Hop On Hop Off" o un taxi solo para subir al Norsk Fjordsenter.</p>
                                    </div>

                                    <div>
                                        <h4 className="font-bold text-fjord-600">15:00 – 16:30: Refugio Cultural (Norsk Fjordsenter)</h4>
                                        <p className="mt-1">Museo interactivo moderno sobre la vida en los fiordos. Cálido, baños impecables y cine panorámico.</p>
                                        <p className="mt-1 text-slate-500">Costo: ~190 NOK (16-17€). Vale la pena por estar seco y entretenido.</p>
                                    </div>

                                    <div>
                                        <h4 className="font-bold text-fjord-600">16:30 – 17:00: La Bajada Épica (Waterfall Walk)</h4>
                                        <p className="mt-1">Baja andando hacia el puerto por las escaleras junto a la cascada Storfossen. Una cascada bajo la lluvia es el doble de impresionante y bajar es fácil (20 min). ¡Cuidado si resbala!</p>
                                    </div>

                                    <div>
                                        <h4 className="font-bold text-fjord-600">17:00 – 17:45: La Recompensa (Geiranger Sjokolade)</h4>
                                        <p className="mt-1">Entra en la fábrica de chocolate. Pide un chocolate caliente artesanal y un bombón. Sécate mientras ves llover.</p>
                                        <p className="mt-1 text-slate-500">Costo: ~8-10€.</p>
                                    </div>

                                    <div>
                                        <h4 className="font-bold text-fjord-600">17:45 – 18:15: La Sala de Espera Final</h4>
                                        <ul className="list-disc ml-4 mt-1 space-y-1">
                                            <li><strong>Opción A (Gratis):</strong> Tienda de souvenirs gigante del puerto.</li>
                                            <li><strong>Opción B (Confort):</strong> Lobby del Hotel Havila (Wi-Fi y sofás).</li>
                                        </ul>
                                    </div>

                                    <div className="bg-emerald-50 p-3 rounded border border-emerald-100 mt-2">
                                        <h4 className="font-bold text-emerald-800 text-xs uppercase mb-1">Resumen Gastos (Aprox)</h4>
                                        <p className="font-mono font-bold text-emerald-700">Total: ~35€ por persona</p>
                                        <p className="text-xs text-emerald-600">Transporte (10€) + Museo (17€) + Chocolate (8€). Un triunfo evitar la hipotermia.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const MapComponent = ({ activities, userLocation, focusedLocation }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const layersRef = useRef([]);

            useEffect(() => {
                if (!mapContainerRef.current || mapInstanceRef.current) return;
                const map = L.map(mapContainerRef.current).setView([62.0876, 6.8607], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);
                mapInstanceRef.current = map;
                return () => { map.remove(); mapInstanceRef.current = null; };
            }, []);

            useEffect(() => {
                const map = mapInstanceRef.current;
                if (!map) return;
                
                layersRef.current.forEach(l => l.remove());
                layersRef.current = [];

                // Custom Icons
                const createIcon = (color) => L.divIcon({
                    className: 'custom-pin',
                    html: `<div style="background-color: ${color}; width: 24px; height: 24px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); border: 2px solid white; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;"><div style="width: 8px; height: 8px; background: white; border-radius: 50%; transform: rotate(45deg);"></div></div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24],
                    popupAnchor: [0, -24]
                });

                // Extra POIs logic
                const EXTRA_POIS = [
                    { title: "Cascada 7 Hermanas", coords: COORDS.SEVEN_SISTERS, color: '#f97316' },
                    { title: "Mirador Ørnesvingen", coords: COORDS.ORNESVINGEN, color: '#f97316' },
                    { title: "Inicio Waterfall Walk", coords: COORDS.STORFOSSEN_START, color: '#f97316' }
                ];

                activities.forEach(act => {
                    const marker = L.marker([act.coords.lat, act.coords.lng], { icon: createIcon('#2A5B87') })
                        .addTo(map).bindPopup(`<b>${act.title}</b><br/>Inicio: ${act.locationName}`);
                    layersRef.current.push(marker);

                    if (act.endCoords) {
                         const endMarker = L.marker([act.endCoords.lat, act.endCoords.lng], { icon: createIcon('#3A7D44') })
                            .addTo(map).bindPopup(`<b>Fin: ${act.title}</b>`);
                        layersRef.current.push(endMarker);
                        const polyline = L.polyline([[act.coords.lat, act.coords.lng], [act.endCoords.lat, act.endCoords.lng]], { color: '#2A5B87', weight: 4, opacity: 0.6, dashArray: '10, 10' }).addTo(map);
                        layersRef.current.push(polyline);
                    }
                });

                // Add Extra POIs
                EXTRA_POIS.forEach(poi => {
                    const marker = L.marker([poi.coords.lat, poi.coords.lng], { icon: createIcon(poi.color) })
                        .addTo(map).bindPopup(`<b>${poi.title}</b>`);
                    layersRef.current.push(marker);
                });

                if (userLocation) {
                    const userMarker = L.circleMarker([userLocation.lat, userLocation.lng], { radius: 8, fillColor: '#3b82f6', color: '#fff', weight: 3, fillOpacity: 1 }).addTo(map);
                    layersRef.current.push(userMarker);
                }
            }, [activities, userLocation]);

            useEffect(() => {
                if(mapInstanceRef.current && focusedLocation) {
                    mapInstanceRef.current.setView([focusedLocation.lat, focusedLocation.lng], 18, { animate: true, duration: 1.5 });
                }
            }, [focusedLocation]);

            return <div ref={mapContainerRef} className="w-full h-full bg-slate-100" />;
        };

        const App = () => {
            const [itinerary, setItinerary] = useState(INITIAL_ITINERARY);
            const [activeTab, setActiveTab] = useState('timeline');
            const [userLocation, setUserLocation] = useState(null);
            const [mapFocus, setMapFocus] = useState(null);
            const [selectedActivity, setSelectedActivity] = useState(null);
            const [countdown, setCountdown] = useState('');
            const [countdownLabel, setCountdownLabel] = useState('Salida');
            const [showAudioPlayer, setShowAudioPlayer] = useState(false);

            useEffect(() => {
                if ('geolocation' in navigator) {
                    const id = navigator.geolocation.watchPosition(
                        p => setUserLocation({ lat: p.coords.latitude, lng: p.coords.longitude }),
                        e => console.warn(e),
                        { enableHighAccuracy: true }
                    );
                    return () => navigator.geolocation.clearWatch(id);
                }
            }, []);

            // Smart Countdown
            useEffect(() => {
                const interval = setInterval(() => {
                    const now = new Date();
                    
                    // Parse Times
                    const [ah, am] = ARRIVAL_TIME.split(':').map(Number);
                    const arrivalDate = new Date(); arrivalDate.setHours(ah, am, 0, 0);

                    const [oh, om] = ONBOARD_TIME.split(':').map(Number);
                    const onboardDate = new Date(); onboardDate.setHours(oh, om, 0, 0);

                    let target, label;

                    if (now < arrivalDate) {
                        target = arrivalDate;
                        label = "Faltan para Llegada";
                    } else {
                        target = onboardDate;
                        label = "Tiempo Restante";
                    }

                    setCountdownLabel(label);

                    const diff = target - now;
                    
                    if (diff <= 0 && target === onboardDate) setCountdown("¡A BORDO!");
                    else if (diff <= 0 && target === arrivalDate) setCountdown("¡LLEGANDO!");
                    else {
                        const hr = Math.floor(diff/(1000*60*60));
                        const mn = Math.floor((diff%(1000*60*60))/(1000*60));
                        const sc = Math.floor((diff%(1000*60))/1000);
                        setCountdown(`${hr}h ${mn}m ${sc}s`);
                    }
                }, 1000);
                return () => clearInterval(interval);
            }, []);

            const handleToggleComplete = (id) => {
                setItinerary(prev => prev.map(a => a.id === id ? { ...a, completed: !a.completed } : a));
            };

            const handleLocate = (c1, c2) => {
                setMapFocus(c1);
                setActiveTab('map');
            };

            const handleOpenAudio = () => {
                setSelectedActivity(null); // Close detail modal
                setShowAudioPlayer(true); // Open audio modal
            };

            return (
                <div className="flex flex-col h-screen bg-slate-50 text-slate-900 font-sans overflow-hidden select-none">
                    <header className="bg-fjord-900 text-white p-3 shadow-md z-20 flex justify-between items-center shrink-0">
                        <div className="flex items-center">
                            <Anchor className="mr-2 text-sunset-500" size={20} />
                            <div>
                                <h1 className="font-bold text-sm leading-none">Todos a Bordo: {ONBOARD_TIME}</h1>
                                <p className="text-[10px] text-fjord-200">Salida Barco: {SHIP_DEPARTURE_TIME}</p>
                            </div>
                        </div>
                        <div className="text-right">
                             <div className="text-[10px] text-sunset-200 uppercase tracking-widest">{countdownLabel}</div>
                             <div className="text-xl font-mono font-bold text-sunset-500 tabular-nums">{countdown}</div>
                        </div>
                    </header>

                    <main className="flex-1 overflow-hidden relative">
                        {activeTab === 'timeline' && <div className="h-full overflow-y-auto"><Timeline itinerary={itinerary} onToggleComplete={handleToggleComplete} onLocate={handleLocate} userLocation={userLocation} onSelectActivity={setSelectedActivity} /></div>}
                        {activeTab === 'map' && <MapComponent activities={itinerary} userLocation={userLocation} focusedLocation={mapFocus} />}
                        {activeTab === 'budget' && <Budget itinerary={itinerary} />}
                        {activeTab === 'guide' && <Guide userLocation={userLocation} />}
                    </main>

                    {selectedActivity && (
                        <ActivityDetailModal 
                            activity={selectedActivity} 
                            onClose={() => setSelectedActivity(null)} 
                            onOpenAudio={handleOpenAudio}
                        />
                    )}

                    {showAudioPlayer && <AudioGuideModal onClose={() => setShowAudioPlayer(false)} />}

                    <nav className="bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-30 pb-safe shrink-0">
                        <div className="flex justify-around items-center h-16">
                            {[
                                { id: 'timeline', icon: CalendarClock, label: 'Itinerario' },
                                { id: 'map', icon: MapIcon, label: 'Mapa' },
                                { id: 'budget', icon: Wallet, label: 'Gastos' },
                                { id: 'guide', icon: BookOpen, label: 'Guía' }
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center w-full h-full justify-center transition-colors ${activeTab === tab.id ? 'text-fjord-600' : 'text-slate-300'}`}>
                                    <tab.icon size={24} strokeWidth={activeTab === tab.id ? 2.5 : 2} />
                                    <span className="text-[10px] mt-1 font-bold">{tab.label}</span>
                                </button>
                            ))}
                        </div>
                    </nav>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>